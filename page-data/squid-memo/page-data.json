{"componentChunkName":"component---src-templates-post-js","path":"/squid-memo/","result":{"data":{"site":{"siteMetadata":{"title":"mojaie.github.io","siteUrl":"https://mojaie.github.io","author":{"name":"Seiji Matsuoka","summary":"Cheminformatics, Biointeraction and Laboratory automation"},"license":"CC BY 4.0","licenseURL":"https://creativecommons.org/licenses/by/4.0/legalcode","social":{"twitter":"mojaie"}}},"markdownRemark":{"id":"560e4cfc-d370-51b0-88f2-d6d102e0c0f1","excerpt":"職場からしかアクセスできないシステム(IPでアクセス制限がかかっている)を自宅からVPN経由で使うためプロキシサーバを建てたときの備忘録。 前提 VPNクライアントは職場から提供されている 職場のUbuntu 16.0…","html":"<p>職場からしかアクセスできないシステム(IPでアクセス制限がかかっている)を自宅からVPN経由で使うためプロキシサーバを建てたときの備忘録。</p>\n<h3>前提</h3>\n<ul>\n<li>VPNクライアントは職場から提供されている</li>\n<li>職場のUbuntu 16.04にプロキシサーバをインストール</li>\n<li>アクセスしたいシステムは職場とは別のドメインにあり、登録された職場のIPアドレスからしかアクセスできない</li>\n</ul>\n<h3>Squidのインストール</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token output\">(サーバ側)\n</span><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> squid</span></span></code></pre></div>\n<h3>confファイルの編集</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token output\">(サーバ側)\n</span><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">vi</span> /etc/squid/squid.conf</span></span></code></pre></div>\n<p>最低限編集が必要なのは以下2ヵ所のみ</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">acl localnet src 172.16.0.0/12</code></pre></div>\n<p>aclの行に接続を許可するホストがコメントアウトされている場合はコメントアウトを外します。\n同じネットワークに属するコンピュータからのアクセスを受付けるため、acl localnetの行のうち該当する行のコメントアウトをはずす。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">http_access allow localnet</code></pre></div>\n<p>上記のコメントアウトをはずして、localnetという名前で定義されたホストのHTTPアクセスを許可する。</p>\n<p>confファイルを編集し終わったら、一旦squidを再起動します。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">systemctl reload squid</span></span></code></pre></div>\n<p>以上。デフォルトのポートは3128なので、クライアントから-xオプションを指定したcurlで通信ができているかどうか確認する(プロキシサーバのホストが172.27.1.2の場合)。</p>\n<p>(クライアント側)</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">curl</span> https://google.com/ -x http://172.27.1.2:3128</span></span></code></pre></div>\n<p>HTTPSリクエストの場合、CONNECTメソッドでトンネリングができているかどうかヘッダを見て確認。サーバ側のログは以下の場所にある。</p>\n<p>(サーバ側)</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">less</span> /var/log/squid/access.log</span></span></code></pre></div>\n<h3>SwitchyOmega</h3>\n<p>WindowsやMacのシステムのプロキシ設定を使うとDropboxやウィルス対策ソフトなど全ての通信がプロキシを経由してしまうので、SwitchyOmegaというChromeのアドオンをインストールしてブラウザで必要な時だけプロキシを経由するよう設定する。</p>\n<p><a href=\"https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif\">https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif</a></p>\n<p>サーバアドレスを手動で登録する、あるいはシステム管理者が公開しているpacファイルをインストールする。Switch Profileでホスト名などの条件に合致する場合自動的にプロキシを経由する設定にもできる。</p>","fields":{"slug":"/squid-memo/"},"frontmatter":{"title":"Squidでプロキシサーバを構築する","dateCreated":"July 11, 2020","dateModified":"August 15, 2020","tags":["Squid","Ubuntu","Chrome","remote","environment setup"],"description":null}},"file":null},"pageContext":{"slug":"/squid-memo/","draft":false,"image":null,"previous":{"fields":{"slug":"/ubuntu20-upgrade/"},"frontmatter":{"title":"SSHリモートでUbuntu20.04にアップグレードした際のメモ","image":null,"draft":false}},"next":{"fields":{"slug":"/ssh-memo/"},"frontmatter":{"title":"Ubuntu16.04でのSSH設定メモ","image":null,"draft":false}}}},"staticQueryHashes":["2841359383","3266777773","401191528"]}