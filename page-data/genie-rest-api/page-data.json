{"componentChunkName":"component---src-templates-post-js","path":"/genie-rest-api/","result":{"data":{"site":{"siteMetadata":{"title":"mojaie.github.io","siteUrl":"https://mojaie.github.io","author":{"name":"Seiji Matsuoka","summary":"Cheminformatics, Biointeraction and Laboratory automation"},"license":"CC BY 4.0","licenseURL":"https://creativecommons.org/licenses/by/4.0/legalcode","social":{"twitter":"mojaie"}}},"markdownRemark":{"id":"1970dd67-9c67-566c-8537-1c12a7d16929","excerpt":"PostgreSQLのデータベースは予め作成しておく必要がある。 GenieとSearchLight(ORM)のインストール 起動スクリプト シンプルなAPIのバックエンドの例\nhttps://geniejl.readthedocs.io/en/latest/guides/Simple_API_backend…","html":"<p>PostgreSQLのデータベースは予め作成しておく必要がある。</p>\n<h3>GenieとSearchLight(ORM)のインストール</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pkg&gt; add Genie\npkg&gt; add SearchLight\npkg&gt; add SearchLightPostgress</code></pre></div>\n<h3>起動スクリプト</h3>\n<p>シンプルなAPIのバックエンドの例\n<a href=\"https://geniejl.readthedocs.io/en/latest/guides/Simple_API_backend/\">https://geniejl.readthedocs.io/en/latest/guides/Simple_API_backend/</a></p>\n<div class=\"gatsby-highlight\" data-language=\"julia\"><pre class=\"language-julia\"><code class=\"language-julia\"><span class=\"token keyword\">using</span> Genie\n<span class=\"token keyword\">import</span> Genie<span class=\"token punctuation\">.</span>Router<span class=\"token punctuation\">:</span> route\n<span class=\"token keyword\">import</span> Genie<span class=\"token punctuation\">.</span>Renderer<span class=\"token punctuation\">.</span>Json<span class=\"token punctuation\">:</span> json\n\nGenie<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>run_as_server <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\nroute<span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">:</span>message <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"Hi there!\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> json\n<span class=\"token keyword\">end</span>\n\nGenie<span class=\"token punctuation\">.</span>startup<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>これだけ。コマンドラインから上記スクリプトを実行するだけでGETリクエストに対してJSONレスポンスを返すサーバが起動する。</p>\n<h3>SearchLightによるデータベースのセットアップ</h3>\n<p><a href=\"https://geniejl.readthedocs.io/en/latest/guides/Working_With_Genie_Apps/#accessing-databases-with-seachlight-models\">https://geniejl.readthedocs.io/en/latest/guides/Working_With_Genie_Apps/#accessing-databases-with-seachlight-models</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">julia&gt; using Genie\n[ Info: Precompiling Genie [c43c736e-a2d1-11e8-161f-af95117fbd1e]\n\njulia&gt; Genie.Generator.db_support()</code></pre></div>\n<p>IO Errorになるが、dbフォルダとconnection.ymlが生成されている。\n(7/9時点) バグがあり、Generatorで生成したファイルにwrite permissionが無いようだ。手動で修正する必要がある。<br>\n<a href=\"https://github.com/GenieFramework/Genie.jl/issues/157\">https://github.com/GenieFramework/Genie.jl/issues/157</a></p>\n<p>connection.ymlを編集してDB接続情報を入力する。</p>\n<h3>DB設定の読み込み</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">julia&gt; SearchLight.Configuration.load()\nDict{String,Any} with 8 entries:\n  &quot;options&quot;  =&gt; Dict{String,String}()\n  &quot;host&quot;     =&gt; &quot;localhost&quot;\n  &quot;password&quot; =&gt; &quot;password&quot;\n  &quot;config&quot;   =&gt; nothing\n  &quot;username&quot; =&gt; &quot;pguser&quot;\n  &quot;port&quot;     =&gt; 5432\n  &quot;database&quot; =&gt; &quot;default&quot;\n  &quot;adapter&quot;  =&gt; &quot;PostgreSQL&quot;</code></pre></div>\n<h3>DB接続</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">julia&gt; SearchLight.Configuration.load() |&gt; SearchLight.connect\nPostgreSQL connection (CONNECTION_OK) with parameters:\n  user = pguser\n  password = ********************\n  dbname = default\n  host = localhost\n  port = 5432\n  client_encoding = UTF8\n  options = -c DateStyle=ISO,YMD -c IntervalStyle=iso_8601 -c TimeZone=UTC\n  application_name = LibPQ.jl\n  sslmode = prefer\n  sslcompression = 0\n  gssencmode = disable\n  krbsrvname = postgres\n  target_session_attrs = any</code></pre></div>\n<p><code class=\"language-text\">SearchLightPostgreSQL.CONNECTIONS</code>に現在接続中のDBの情報が配列として格納されている。</p>\n<h3>クエリ実行</h3>\n<p>julia> SearchLight.query(“SELECT * FROM substances”)\n[ Info: SELECT * FROM substances\n0.351419 seconds (107.96 k allocations: 5.602 MiB, 6.16% gc time)\n2327×2 DataFrames.DataFrame\n│ Row  │ id           │ origin      │\n│      │ String⍰      │ String⍰     │\n├──────┼──────────────┼─────────────┤\n│ 1    │ DB0000000001 │ DrugBankFDA │\n│ 2    │ DB0000000002 │ DrugBankFDA │\n│ 3    │ DB0000000003 │ DrugBankFDA │\n│ 4    │ DB0000000004 │ DrugBankFDA │\n│ 5    │ DB0000000005 │ DrugBankFDA │\n│ 6    │ DB0000000006 │ DrugBankFDA │\n⋮\n│ 2321 │ DB0000002321 │ DrugBankFDA │\n│ 2322 │ DB0000002322 │ DrugBankFDA │\n│ 2323 │ DB0000002323 │ DrugBankFDA │\n│ 2324 │ DB0000002324 │ DrugBankFDA │\n│ 2325 │ DB0000002325 │ DrugBankFDA │\n│ 2326 │ DB0000002326 │ DrugBankFDA │\n│ 2327 │ DB0000002327 │ DrugBankFDA │</p>\n<h1>モデルの作成</h1>\n<p>julia> SearchLight.Generator.newresource(“Substance”)\n[ Info: New model created at /Users/smatsuoka/Workspace/apiserver/app/resources/substances/Substances.jl\n[ Info: New table migration created at /Users/smatsuoka/Workspace/apiserver/db/migrations/2020070912544364<em>create</em>table<em>substances.jl\n[ Info: New validator created at /Users/smatsuoka/Workspace/apiserver/app/resources/substances/SubstancesValidator.jl\n[ Info: New unit test created at /Users/smatsuoka/Workspace/apiserver/test/substances</em>test.jl</p>\n<p>モデル、マイグレーションスクリプト、バリデーター、ユニットテストのファイルが生成される。</p>","fields":{"slug":"/genie-rest-api/"},"frontmatter":{"title":"GenieとPostgreSQLでREST APIサーバを構築","dateCreated":"July 09, 2020","dateModified":"July 09, 2020","tags":["Julia","PostgreSQL"],"description":null}}},"pageContext":{"slug":"/genie-rest-api/","draft":false,"previous":{"fields":{"slug":"/inchi-memo/"},"frontmatter":{"title":"InChI実装メモ","draft":false}},"next":{"fields":{"slug":"/postgrest-memo/"},"frontmatter":{"title":"PostgRESTメモ","draft":false}}}}}