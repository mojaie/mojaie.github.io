{"componentChunkName":"component---src-templates-post-js","path":"/postgres_chembl_memo/","result":{"data":{"site":{"siteMetadata":{"title":"mojaie.github.io","siteUrl":"https://mojaie.github.io","author":{"name":"Seiji Matsuoka","summary":"Cheminformatics, Biointeraction and Laboratory automation"},"license":"CC BY 4.0","licenseURL":"https://creativecommons.org/licenses/by/4.0/legalcode","social":{"twitter":"mojaie"}}},"markdownRemark":{"id":"fa1f801e-3f36-5291-b406-b5d4bb286353","excerpt":"環境 MacOS: 11.5 Docker Desktop: 3.5.2 PostgreSQL: 13.3 ChEMBL: 29 ChEMBLダウンロード Downloads https://chembl.gitbook.io/chembl-interface-documentation/downloads…","html":"<h3>環境</h3>\n<ul>\n<li>MacOS: 11.5</li>\n<li>Docker Desktop: 3.5.2</li>\n<li>PostgreSQL: 13.3</li>\n<li>ChEMBL: 29</li>\n</ul>\n<h3>ChEMBLダウンロード</h3>\n<p>Downloads<br>\n<a href=\"https://chembl.gitbook.io/chembl-interface-documentation/downloads\">https://chembl.gitbook.io/chembl-interface-documentation/downloads</a></p>\n<p>公式のPostgreSQL dmpファイルをダウンロードして解凍、適当なresourceフォルダに設置。</p>\n<h3>データベースの作成</h3>\n<p>Postgresはdocker-composeで設定済み。volumesにresourceフォルダを指定。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: &#39;3&#39;\nservices:\n  db:\n    image: postgres\n    container_name: PostgreSQL\n    ports:\n      - &quot;5432:5432&quot;\n    environment:\n      POSTGRES_DB: default\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD_FILE: /run/secrets/postgres-passwd\n    volumes:\n      - ./postgres:/docker-entrypoint-initdb.d\n      - ./postgres/data:/var/lib/postgresql/data\n      - ./resources:/resources\n    secrets:\n      - postgres-passwd\n...</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker-compose up -d</code></pre></div>\n<p>postgresコンテナにログインしてCLIを開く。psqlログイン。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">psql -U postgres</code></pre></div>\n<p>ChEMBLダウンロードファイルのインストラクションに従ってcreate database</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">postgres=# create database chembl_29;</code></pre></div>\n<p><code class=\"language-text\">\\l</code>でDBのリストが確認できる。chembl_29ができていれば<code class=\"language-text\">\\q</code>で終了。</p>\n<p>リストアコマンドを入力</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pg_restore --no-owner -U postgres -d chembl_29 ./resources/chembl_29_postgresql/chembl_29_postgresql.dmp</code></pre></div>\n<p>・・・</p>\n<p>・・・</p>\n<p>・・・</p>\n<p>かなり時間がかかるのでやめた。一旦dropして再度create。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">postgres=# drop database chembl_29;\npostgres=# create database chembl_29;</code></pre></div>\n<h3>必要なテーブルだけをリストアする</h3>\n<p>実は必要なテーブルは2つだけだったので、必要なテーブルだけをrestoreすることにした。\n<code class=\"language-text\">-t</code>コマンドで特定のテーブルのみをリストアできるが、テーブル名が間違っているのかリストアできてなかった。</p>\n<p>一旦<code class=\"language-text\">-l</code>コマンドでdumpの中身を確認したら、どうもドキュメントのスキーマ一覧ではテーブル名は大文字表記なのに、実際には小文字だったようだ。あらためて<code class=\"language-text\">-t</code>でリストアされるテーブルを確認する。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pg_restore -l -t structural_alerts ./resources/chembl_29_postgresql/chembl_29_postgresql.dmp</code></pre></div>\n<p>出力:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...(省略)...\n;\n; Selected TOC Entries:\n;\n236; 1259 194809 TABLE public structural_alerts user\n3124; 0 194809 TABLE DATA public structural_alerts user</code></pre></div>\n<p>今度はTOC Entriesが表示されているので大丈夫そうである。気を取り直してpg_restoreする。<code class=\"language-text\">--no-owner</code>を付けると元のデータベースの権限を無視してリストアしたユーザが所有者になる。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pg_restore --no-owner -U postgres -d chembl_29 -t structural_alerts ./resources/chembl_29_postgresql/chembl_29_postgresql.dmp\npg_restore --no-owner -U postgres -d chembl_29 -t structural_alert_sets ./resources/chembl_29_postgresql/chembl_29_postgresql.dmp</code></pre></div>\n<p>2つとも非常に小さいテーブルなのですぐにリストアが完了する。内容を確認する。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">psql -U postgres -d chembl_29\nchembl_29=# select * from structural_alerts;</code></pre></div>\n<p>出力:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...(省略)...\n        1 |            1 | R1 Reactive alkyl halides                    | [Br,Cl,I][CX4;CH,CH2]\n        2 |            1 | R2 Acid halides                              | [S,C](=[O,S])[F,Br,Cl,I]\n        3 |            1 | R3 Carbazides                                | O=CN=[N+]=[N-]</code></pre></div>\n<p>問題なさそうである。</p>","fields":{"slug":"/postgres_chembl_memo/"},"frontmatter":{"title":"ChEMBLのPostgreSQLへの取り込みメモ","dateCreated":"August 09, 2021","dateModified":"August 09, 2021","tags":["PostgreSQL","Docker","ChEMBL"],"description":null}},"file":null},"pageContext":{"slug":"/postgres_chembl_memo/","draft":false,"image":null,"previous":{"fields":{"slug":"/julia-notebook-parallel/"},"frontmatter":{"title":"Jupyter NotebookでJuliaをマルチスレッドで実行する","image":null,"draft":false}},"next":{"fields":{"slug":"/julia-package-admin/"},"frontmatter":{"title":"Juliaパッケージ管理メモ","image":null,"draft":false}}}},"staticQueryHashes":["2841359383","3266777773","401191528"]}