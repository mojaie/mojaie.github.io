{"componentChunkName":"component---src-templates-post-js","path":"/ubuntu20-upgrade/","result":{"data":{"site":{"siteMetadata":{"title":"mojaie.github.io","siteUrl":"https://mojaie.github.io","author":{"name":"Seiji Matsuoka","summary":"Cheminformatics, Biointeraction and Laboratory automation"},"license":"CC BY 4.0","licenseURL":"https://creativecommons.org/licenses/by/4.0/legalcode","social":{"twitter":"mojaie"}}},"markdownRemark":{"id":"21400861-5fb7-5538-8048-7030ca48b6af","excerpt":"在宅なのでリモートでアップデートしました。あまり推奨はされないらしいです。 How to upgrade from Ubuntu 18.04 LTS to 20.04 LTS today \nhttps://ubuntu.com/blog/how-to-upgrade-from-ubuntu-18-04-lts-to…","html":"<p>在宅なのでリモートでアップデートしました。あまり推奨はされないらしいです。</p>\n<p>How to upgrade from Ubuntu 18.04 LTS to 20.04 LTS today\n<a href=\"https://ubuntu.com/blog/how-to-upgrade-from-ubuntu-18-04-lts-to-20-04-lts-today\">https://ubuntu.com/blog/how-to-upgrade-from-ubuntu-18-04-lts-to-20-04-lts-today</a></p>\n<p><code class=\"language-text\">do-release-upgrade</code>コマンドを使用します。-dオプションはdevelopmentリリースのインストールを指定しますが、2020/8/15時点で必須のようです(通常新リリースから3ヶ月くらい経つと普通にインストールできるようになるらしい)。旧バージョンがdesktopであればdesktop、serverであればserverの新バージョンがデフォルトでインストールされます。modeオプションでdesktopかserverを変更することが可能です。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> do-release-upgrade -d</span></span>\n<span class=\"token output\">新しい Ubuntu のリリースをチェックしています\nPlease install all available updates for your release before upgrading.</span></code></pre></div>\n<p>利用可能なアップデートは全てインストールしろと言われるのでします。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</span></span>\n<span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> upgrade</span></span>\n<span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> dist-upgrade</span></span></code></pre></div>\n<p>dist-upgradeのときにautoremoveしろといわれるのでします。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> autoremove</span></span></code></pre></div>\n<p><code class=\"language-text\">do-release-upgrade</code>再チャレンジ。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> do-release-upgrade -d</span></span>\n<span class=\"token output\">新しい Ubuntu のリリースをチェックしています\nYou have not rebooted after updating a package which requires a reboot. Please reboot before upgrading.</span></code></pre></div>\n<p>再起動しろと言われるのでします。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">reboot</span></span></span></code></pre></div>\n<p>再起動したらSSH再接続して<code class=\"language-text\">do-release-upgrade</code>します。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> do-release-upgrade -d</span></span>\n<span class=\"token output\">[sudo] server のパスワード: \n新しい Ubuntu のリリースをチェックしています\n0% [作業中]\n0% [jp.archive.ubuntu.com へ接続しています]\n0% [jp.archive.ubuntu.com (160.26.2.187) へ接続しています]\n0% [ヘッダの待機中です]\n\n...\n\n取得:1 ツールの署名のアップグレード [1,554 B]\n99% [ヘッダの待機中です]\n取得:2 ツールのアップグレード [1,348 kB]\n100% [作業中]\n1,350 kバイト/0秒 を取得しました (0 B/秒)\n「focal.tar.gz.gpg」を用いて「focal.tar.gz」の認証を行ないます\n'focal.tar.gz' の展開中\n\nキャッシュを読み込み中\n\nパッケージマネージャーをチェック中です\n\nSSH経由で実行していますが、続けますか？\n\n\nこのセッションはSSH上で実行されているようです。アップグレードをSSH越しに行うことは推奨されません。アップグレードに失敗した時の復元が困難になるからです。\n\n続行する場合、追加のSSHデーモンをポート '1022' で起動します。 \n本当に作業を進めてよろしいですか？ \n\n続行する[yN]</span></code></pre></div>\n<p>SSHでのアップデートは推奨されないようです。構わずyを押します。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token output\">予備のsshdを開始します \n\n障害が起こったときに復旧しやすくするため、ポート '1022' でもう一つの sshd \nを開始します。現在実行中のsshにおかしなことが起きても、もう一方のポートに接続することができます。 \n\nファイアウォールを実行している場合、このポートを一時的に開く必要があります。この操作は、潜在的な危険があるため自動的には行われません。以下の例のようにしてポートを開けます: \n'iptables -I INPUT -p tcp --dport 1022 -j ACCEPT' \n\n続けるには [ENTER] キーを押してください</span></code></pre></div>\n<p>続けます。ENTERです。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token output\">パッケージリストを読み込んでいます... 完了  \n依存関係ツリーを作成しています           \n状態情報を読み取っています... 完了      \n0% [作業中]\n0% [作業中]\n0% [jp.archive.ubuntu.com へ接続しています]\n0% [jp.archive.ubuntu.com へ接続しています]\n\n...\n\n100% [作業中]\n52.5 Mバイト/0秒 を取得しました (0 B/秒)\n\nパッケージマネージャーをチェック中です\nパッケージリストを読み込んでいます... 完了\n依存関係ツリーを作成しています\n状態情報を読み取っています... 完了\n\n変更点を確認中\n\n変更点を確認中\n\nアップグレードを開始しますか？\n\n\n14 個のインストール済みパッケージは Canonical\nによってサポートされなくなりました。ただしコミュニティからのサポートは受けることができます。\n\n50 個のパッケージが削除されます。 356 個の新規パッケージがインストールされます。 1859\n個のパッケージがアップグレードされます。\n\n合計 1,388 M をダウンロードする必要があります。 このダウンロードは 1Mbit DSL 接続で約 2 時間 56 分、56kモデムで約 2 日 5 時間 かかります。\n\nアップグレードの取得とインストールには数時間かかることがあります。ダウンロードが完了してしまうと、処理はキャンセルできません。\n\n 続行する[yN]  詳細 [d]</span></code></pre></div>\n<p>ダウンロードに時間がかかるようです。回線環境を確認してyします。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token output\">取得中\n0% [作業中]\n0% [作業中]\n\n...\n\n設定ファイル '/etc/squid/squid.conf'\n ==> これはインストールしてから (あなたかスクリプトによって) 変更されています。\n ==> パッケージ配布元が更新版を提供しています。\n   どうしますか? 以下の選択肢があります:\n    Y か I  : パッケージメンテナのバージョンをインストールする\n    N か O  : 現在インストールされている自分のバージョンを残す\n      D     : 両バージョンの差異を表示する\n      Z     : 状況を調査するためにシェルを開始する\n デフォルトでは現在使っている自分のバージョンを残します。\n*** squid.conf (Y/I/N/O/D/Z) [デフォルト=N] ? </span></code></pre></div>\n<p>寝ている間に完了するかと思っていたら、途中でsquidどうする？と聞かれたまま止まってました。この間にVPSがタイムアウトしてしまったので痛恨のssh切断。</p>\n<p>再度sshログインしてアップデートを試みます。既に20.04にはなっていますが、必要なファイルの設定が済んでいません。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> dist-upgrade</span></span>\n<span class=\"token output\">[sudo] server のパスワード: \nWaiting for cache lock: Could not get lock /var/lib/dpkg/lock. It is held by pro</span></code></pre></div>\n<p>強制シャットダウンしたのでロックがかかったままになっています。ask-ubuntuで見たあらゆるロックファイルを消してみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">rm</span> /var/lib/apt/lists/lock</span></span>\n<span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">rm</span> /var/cache/apt/archives/lock</span></span>\n<span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">rm</span> /var/lib/dpkg/lock</span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> dist-upgrade</span></span>\n<span class=\"token output\">E: dpkg は中断されました。問題を修正するには 'sudo dpkg --configure -a' を手動で実行する必要があります。</span></code></pre></div>\n<p>どうやらアップデート途中から再開できるようです。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> dpkg --configure -a</span></span>\n<span class=\"token output\">squid (4.10-1ubuntu1.1) を設定しています ...\n\n設定ファイル '/etc/squid/squid.conf'\n ==> これはインストールしてから (あなたかスクリプトによって) 変更されています。\n ==> パッケージ配布元が更新版を提供しています。\n   どうしますか? 以下の選択肢があります:\n    Y か I  : パッケージメンテナのバージョンをインストールする\n    N か O  : 現在インストールされている自分のバージョンを残す\n      D     : 両バージョンの差異を表示する\n      Z     : 状況を調査するためにシェルを開始する\n デフォルトでは現在使っている自分のバージョンを残します。\n*** squid.conf (Y/I/N/O/D/Z) [デフォルト=N] ? </span></code></pre></div>\n<p>戻ってこれました。回答してインストールを続けます。パッケージをアップデートします。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> dist-upgrade</span></span>\n<span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> autoremove</span></span></code></pre></div>\n<p>これで完了です。</p>","fields":{"slug":"/ubuntu20-upgrade/"},"frontmatter":{"title":"SSHリモートでUbuntu20.04にアップグレードした際のメモ","dateCreated":"August 15, 2020","dateModified":"August 15, 2020","tags":["SSH","Ubuntu","remote","environment setup"],"description":null}}},"pageContext":{"slug":"/ubuntu20-upgrade/","draft":false,"previous":{"fields":{"slug":"/rabbitmq-c-memo/"},"frontmatter":{"title":"rabbitmq Cクライアントメモ","draft":false}},"next":{"fields":{"slug":"/squid-memo/"},"frontmatter":{"title":"Squidでプロキシサーバを構築する","draft":false}}}}}